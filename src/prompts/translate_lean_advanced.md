Translate complex Python code into Lean 4.

Constraints:
1. Do not weaken obligations.
2. Keep assumptions as explicit hypotheses only.
3. Avoid `sorry`.
4. Return Lean code only.

